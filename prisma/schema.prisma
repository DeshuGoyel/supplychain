generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                    String   @id @default(cuid())
  email                 String   @unique
  password              String   // bcrypt hashed
  name                  String
  role                  String   @default("MANAGER") // MANAGER, PLANNER, COORDINATOR, FINANCE
  companyId             String
  company               Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  // SSO & 2FA Extensions
  ssoProvider           String?  // google, microsoft, saml
  ssoProviderId         String?
  twoFactorEnabled      Boolean  @default(false)
  twoFactorSecret       String?  // encrypted TOTP secret
  twoFactorBackupCodes  String?  // JSON array of backup codes, hashed
  lastLoginAt           DateTime?
  loginAttempts         Int      @default(0)
  lockedUntil           DateTime?
  
  // Relations
  auditLogs             AuditLog[]
  legalAcceptances      UserLegalAcceptance[]
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  @@index([companyId])
  @@map("users")
}

model Company {
  id                    String             @id @default(cuid())
  name                  String
  industry              String   // Manufacturing, Retail, Healthcare
  employees             Int
  
  // Subscription fields
  subscriptionStatus    String?  @default("trial") // trial, active, inactive, cancelled
  subscriptionTier      String?  @default("starter") // starter, growth, enterprise
  trialStart            DateTime?
  trialEnd              DateTime?
  nextBillingDate       DateTime?
  stripeCustomerId      String?  @unique
  stripeSubscriptionId  String?  @unique
  billingEmail          String?
  billingAddress        String?
  taxId                 String?
  
  users                 User[]
  inventory             Inventory[]
  orders                Order[]
  suppliers             Supplier[]
  demandForecasts       DemandForecast[]
  kpis                  KPI[]
  locations             Location[]
  purchaseOrders        PurchaseOrder[]
  shipments             Shipment[]
  
  // White-labeling relation
  whiteLabel            WhiteLabel?
  
  // SSO integrations
  ssoIntegrations       SSOIntegration[]
  
  // Billing relations
  payments              Payment[]
  invoices              Invoice[]
  auditLogs             AuditLog[]
  
  // Usage tracking relations
  usageMetrics          UsageMetric[]
  usageLimit            UsageLimit?
  
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt

  @@map("companies")
}

model WhiteLabel {
  id                      String   @id @default(cuid())
  companyId               String   @unique
  company                 Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  enabled                 Boolean  @default(false)
  logoUrl                 String?
  faviconUrl              String?
  primaryColor            String?  @default("#3b82f6")
  secondaryColor          String?  @default("#1e40af")
  customDomain            String?  @unique
  hideSupplyChainBranding Boolean  @default(false)
  customFooterText        String?
  termsOfServiceUrl       String?
  privacyPolicyUrl        String?
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  @@map("white_labels")
}

model SSOIntegration {
  id            String   @id @default(cuid())
  companyId     String
  company       Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  provider      String   // google | microsoft | okta | saml
  clientId      String
  clientSecret  String   // encrypted
  enabled       Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([companyId])
  @@map("sso_integrations")
}

model AuditLog {
  id          String   @id @default(cuid())
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  action      String   // LOGIN | LOGOUT | SSO_ATTEMPT | 2FA_ENABLED | etc
  ipAddress   String?
  userAgent   String?
  success     Boolean  @default(true)
  timestamp   DateTime @default(now())

  @@index([companyId])
  @@index([userId])
  @@map("audit_logs")
}

model Payment {
  id                    String   @id @default(cuid())
  companyId             String
  company               Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  stripePaymentIntentId String   @unique
  amount                Float
  currency              String   @default("USD")
  status                String   // pending | succeeded | failed
  paymentMethod         String?
  description           String?
  metadata              Json?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([companyId])
  @@map("payments")
}

model Invoice {
  id               String    @id @default(cuid())
  companyId        String
  company          Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  stripeInvoiceId  String    @unique
  subscriptionId   String?
  amount           Float
  status           String    // draft | sent | paid | void | uncollectible
  pdfUrl           String?
  issuedAt         DateTime  @default(now())
  dueDate          DateTime?
  paidAt           DateTime?
  createdAt        DateTime  @default(now())

  @@index([companyId])
  @@map("invoices")
}

model Plan {
  id            String   @id @default(cuid())
  stripePriceId String   @unique
  name          String   // Starter | Growth | Enterprise
  tier          String   // starter | growth | enterprise
  monthlyPrice  Float
  yearlyPrice   Float
  features      Json     // Array of features
  maxUsers      Int
  maxApiCalls   Int
  maxStorageGb  Int
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("plans")
}

model Inventory {
  id            String    @id @default(cuid())
  companyId     String
  company       Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  locationId    String?
  location      Location? @relation(fields: [locationId], references: [id], onDelete: SetNull)
  sku           String
  name          String
  quantity      Int
  quantityReserved Int    @default(0)
  unitCost      Float
  stockLevel    String    @default("HEALTHY") // HEALTHY, LOW, OUT_OF_STOCK
  turnoverRate  Float?
  reorderPoint  Int?
  reorderQty    Int?
  safetyStock   Int?
  supplierId    String?
  supplier      Supplier? @relation(fields: [supplierId], references: [id], onDelete: SetNull)
  lastUpdated   DateTime  @updatedAt
  createdAt     DateTime  @default(now())

  @@unique([companyId, sku, locationId])
  @@index([companyId])
  @@index([locationId])
  @@index([stockLevel])
  @@index([supplierId])
  @@map("inventory")
}

model Order {
  id          String   @id @default(cuid())
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  supplierId  String
  supplier    Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  orderNumber String
  status      String   @default("PENDING") // PENDING, ON_TIME, DELAYED, COMPLETED
  priority    String   @default("MEDIUM")  // LOW, MEDIUM, HIGH
  eta         DateTime
  daysOverdue Int      @default(0)
  totalAmount Float?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([companyId])
  @@index([supplierId])
  @@index([status])
  @@map("orders")
}

model Supplier {
  id              String          @id @default(cuid())
  companyId       String
  company         Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  orders          Order[]
  inventory       Inventory[]
  purchaseOrders  PurchaseOrder[]
  name            String
  contactName     String?
  contactEmail    String?
  contactPhone    String?
  address         String?
  onTimeRate      Float           @default(0)  // percentage
  qualityRate     Float           @default(0)  // percentage
  leadTime        Float           @default(0)  // days
  performanceScore Float          @default(0)  // 0-100
  paymentTerms    String?         // e.g., "Net 30"
  status          String          @default("ACTIVE") // ACTIVE, INACTIVE
  issues          String?         // JSON array of issues
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([companyId])
  @@index([status])
  @@map("suppliers")
}

model DemandForecast {
  id         String   @id @default(cuid())
  companyId  String
  company    Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  week       Int
  year       Int
  demand     Int
  supply     Int
  gap        Int
  riskLevel  String   @default("CAUTION") // SAFE, CAUTION, RISK
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([companyId, week, year])
  @@index([companyId])
  @@index([week, year])
  @@map("demand_forecasts")
}

model KPI {
  id         String   @id @default(cuid())
  companyId  String
  company    Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  name       String   // OTIF, DIO, FILL_RATE, TURNOVER
  value      Float
  trend      Float    // percentage change from previous period
  target     Float
  status     String   @default("ON_TRACK") // EXCELLENT, ON_TRACK, AT_RISK
  period     String   // e.g., "2025-01"
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([companyId, name, period])
  @@index([companyId])
  @@index([name])
  @@index([period])
  @@map("kpis")
}

model Location {
  id          String      @id @default(cuid())
  companyId   String
  company     Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  name        String
  type        String      // WAREHOUSE, RETAIL, SUPPLIER, DISTRIBUTION_CENTER
  address     String?
  city        String?
  state       String?
  country     String?
  zipCode     String?
  capacity    Int?
  inventory   Inventory[]
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([companyId])
  @@index([type])
  @@map("locations")
}

model PurchaseOrder {
  id          String        @id @default(cuid())
  companyId   String
  company     Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  supplierId  String
  supplier    Supplier      @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  poNumber    String
  status      String        @default("DRAFT") // DRAFT, SUBMITTED, APPROVED, IN_TRANSIT, RECEIVED, CANCELLED
  totalAmount Float         @default(0)
  dueDate     DateTime?
  receivedDate DateTime?
  notes       String?
  lineItems   POLineItem[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@unique([companyId, poNumber])
  @@index([companyId])
  @@index([supplierId])
  @@index([status])
  @@map("purchase_orders")
}

model POLineItem {
  id              String        @id @default(cuid())
  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  sku             String
  productName     String
  quantity        Int
  unitPrice       Float
  totalPrice      Float
  receivedQty     Int           @default(0)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([purchaseOrderId])
  @@map("po_line_items")
}

model Shipment {
  id              String              @id @default(cuid())
  companyId       String
  company         Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  trackingNumber  String
  carrier         String
  status          String              @default("PENDING") // PENDING, PICKED, SHIPPED, IN_TRANSIT, DELIVERED, DELAYED, CANCELLED
  fromLocation    String
  toLocation      String
  eta             DateTime?
  actualDelivery  DateTime?
  daysLate        Int                 @default(0)
  orderReference  String?
  totalValue      Float?
  items           String?             // JSON array of items
  timeline        ShipmentTimeline[]
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@unique([companyId, trackingNumber])
  @@index([companyId])
  @@index([status])
  @@index([carrier])
  @@map("shipments")
}

model ShipmentTimeline {
  id          String    @id @default(cuid())
  shipmentId  String
  shipment    Shipment  @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  status      String    // PICKED, SHIPPED, IN_TRANSIT, OUT_FOR_DELIVERY, DELIVERED, EXCEPTION
  location    String?
  notes       String?
  timestamp   DateTime  @default(now())
  createdAt   DateTime  @default(now())

  @@index([shipmentId])
  @@index([timestamp])
  @@map("shipment_timeline")
}

model LegalDocument {
  id            String   @id @default(cuid())
  type          String   // TERMS_OF_SERVICE | PRIVACY_POLICY | COOKIE_POLICY | ACCEPTABLE_USE | DPA
  version       String
  title         String
  content       String   @db.Text
  effectiveDate DateTime
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())

  @@unique([type, version])
  @@index([type])
  @@map("legal_documents")
}

model UserLegalAcceptance {
  id            String        @id @default(cuid())
  userId        String
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  documentType  String        // TERMS_OF_SERVICE | PRIVACY_POLICY | etc
  version       String
  acceptedAt    DateTime      @default(now())
  ipAddress     String?
  userAgent     String?

  @@unique([userId, documentType])
  @@index([userId])
  @@index([documentType])
  @@map("user_legal_acceptances")
}

model UsageMetric {
  id          String   @id @default(cuid())
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  metricType  String   // API_CALLS | ORDERS_PROCESSED | ACTIVE_USERS | STORAGE_GB
  value       Float
  period      DateTime @db.Date // Period for this metric (usually day or month)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([companyId, metricType, period])
  @@index([companyId])
  @@index([metricType])
  @@index([period])
  @@map("usage_metrics")
}

model UsageLimit {
  id             String   @id @default(cuid())
  companyId      String   @unique
  company        Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  apiCallsUsed   Int      @default(0)
  apiCallsLimit  Int      @default(10000)
  storageUsed    Float    @default(0)
  storageLimit   Float    @default(5) // GB
  lastResetAt    DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("usage_limits")
}
